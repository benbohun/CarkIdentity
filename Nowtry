# Import psPAS Module
Import-Module psPAS

# Prompt user for CyberArk credentials
$UPCred = Get-Credential

# Get header authentication (PCLOUD Admins Only)
$header = Get-IdentityHeader -IdentityTenantURL "aat4012.id.cyberark.cloud" -psPASFormat -PCloudSubdomain "cna-prod" -UPCreds $UPCred

# Register to use header credentials for PAS session
Use-PASSession $header

# Fetch all PAS accounts
$PASAccounts = Get-PASAccount

# Inspect the structure of the first account
Write-Output "First account structure:"
$PASAccounts | Select-Object -First 1 | Format-List *

# Extract and format data for CSV export
$PASAccountsFormatted = $PASAccounts | ForEach-Object {
    [PSCustomObject]@{
        AccountID                   = $_.id  # Try `id` instead of `AccountID`
        Safe                        = $_.safeName  # Try `safeName` instead of `Safe`
        Address                     = $_.address
        UserName                    = $_.userName
        Name                        = $_.name
        PlatformId                  = $_.platformId
        SecretType                  = $_.secretType
        PlatformAccountProperties    = ($_.'platformAccountProperties' -join "; ")
        SecretManagement             = ($_.'secretManagement' -join "; ")
        CreatedTime                 = $_.createdTime
        CategoryModificationTime     = $_.categoryModificationTime
    }
}

# Define CSV export path
$exportPath = "C:\PASAccounts.csv"

# Export to CSV
$PASAccountsFormatted | Export-Csv -Path $exportPath -NoTypeInformation

# Output completion message
Write-Output "PAS accounts have been exported to: $exportPath"
